# 循環動態シミュレーション数理モデル・パラメータ最適化API

## 概要

このプロジェクトは、循環動態をシミュレーションする数理モデルに対して、遺伝的アルゴリズムを用いたパラメータ最適化APIを実装したものです。　　
数理モデルでは、心臓の収縮と弛緩、血液の流れ、圧力の変化などを表現し、様々な生理的状態や病態における循環動態を解析することができます。　　
最適化に関しては、APIより平均27秒ほどで、複数のモデルパラメータを最適化できます。　　
現在APIは関係者のみの非公開となっています。

## 特徴

- 心臓（右房、右室、左房、左室）、肺循環、体循環を含む包括的なモデル
- 電気回路アナロジーを用いた直感的な表現
- 時変エラスタンス関数による心臓の収縮表現
- 弁機能のモデル化による一方向血流の再現
- 遺伝的アルゴリズムを用いたパラメータ最適化機能

## モデル構造

このモデルは以下の主要コンポーネントで構成されています：

1. 4つの心腔（RA, RV, LA, LV）
2. 4つの心臓弁（三尖弁, 肺動脈弁, 僧帽弁, 大動脈弁）
3. 体循環系（動脈、静脈、毛細血管床）
4. 肺循環系（動脈、静脈、毛細血管床）
5. 近位および遠位血管セグメント

各コンポーネントは抵抗（R）とコンプライアンス（C）の組み合わせでモデル化されています。



## API使用方法

## APIの入力について
APIは以下の形式のJSONデータを受け付けます：
```json
{
  "target_metrics": [
    [52.5, "stroke_volume", 1.0],
    [10.3, "central_venous_pressure", 20.0],
    [20.7, "pulmonary_capillary_wedge_pressure", 4.0],
    [126.1, "systolic_arterial_pressure", 0.8],
    [69.5, "diastolic_arterial_pressure", 1.0],
    [46.6, "systolic_pulmonary_arterial_pressure", 2.0],
    [21.1, "diastolic_pulmonary_arterial_pressure", 2.0],
    [55.0, "left_ventricular_ejection_fraction", 1.0]
  ],
  "param_updates": {
    "HR": [80.0, null, false],
    "LV_V0": [10.0, [5.0, 15.0], true]
  },
  "num_repeats": 1
}
```
### 入力パラメータの説明

1. target_metrics: 目標とする循環動態の指標（必須）

  * 形式: [目標値, 指標名, 重み]
  * 全8項目（上記例参照）を必ず含める必要があります
  * 重みは最適化過程でその指標の重要度を決定します

2. param_updates: 更新または固定したいパラメータ（オプション）

  * 形式: "パラメータ名": [値, 範囲, フィッティングフラグ]
  * 値: 新しい値（nullの場合、現在の値を保持）
  * 範囲: 新しい範囲 [最小値, 最大値]（nullの場合、デフォルト範囲を使用）
  * フィッティングフラグ: true（最適化対象）またはfalse（固定値）

3. num_repeats: 最適化プロセスの繰り返し回数（オプション、デフォルト: 1）

### 注意事項

* target_metricsの8項目は全て指定する必要があります。
* param_updatesを指定しない場合、デフォルトのパラメータ設定が使用されます。
* パラメータを固定したい場合（例：HR）、フィッティングフラグをfalseに設定します。
* 最適化の精度を上げるにはnum_repeatsを増やしますが、計算時間も増加します。

### 主要なパラメータ

* HR: 心拍数
* Rcs, Rcp, Ras, Rvs, etc.: 各部位の血管抵抗
* Cas, Cvs, Cap, Cvp: 各部位の血管コンプライアンス
* LV_Ees, RV_Ees, LA_Ees, RA_Ees: 各心腔の収縮末期エラスタンス
* LV_alpha, LV_beta, etc.: 心室の拡張性パラメータ

詳細なパラメータリストとその意味については、パラメータ詳細ドキュメントを参照してください。

## API出力例

最適化プロセス完了後、APIは以下のような JSON レスポンスを返します：

```json
{
  "best_parameters": {
    "parameters": {
      "Rcs": {
        "value": 842.5,
        "default": 830.0,
        "range": [400.0, 1000.0],
        "fitting": true
      },
      "Cas": {
        "value": 1.95,
        "default": 1.83,
        "range": [0.5, 4.0],
        "fitting": true
      },
      "LV_Ees": {
        "value": 2.18,
        "default": 2.21,
        "range": [1.0, 3.0],
        "fitting": true
      },
      // ... 他のパラメータ ...
      "HR": {
        "value": 80.0,
        "default": 90.0,
        "range": [90.0, 90.0],
        "fitting": false
      }
    }
  },
  "best_fitness": 0.0023
}
```

## APIの出力について

* best_parameters: 最適化された各パラメータの情報を含みます。

  * value: 最適化後の値
  * default: デフォルト値
  * range: 許容範囲
  * fitting: 最適化の対象だったかどうか（true/false）


* best_fitness: 最適化アルゴリズムが達成した最良の適合度（誤差）。値が小さいほど、目標の指標に近いことを意味します。

## 応用例

* 心不全患者の病態理解と治療戦略の検討
* 循環器系薬剤の効果予測
* 手術前後の循環動態変化の予測
* 生理学的研究における仮説検証

## 注意事項

このモデルは簡略化された表現であり、実際の生体システムのすべての複雑さを捉えているわけではありません。
パラメータの最適化結果は、与えられた目標値と初期条件に大きく依存します。
モデルの妥当性は、常に実験データや臨床データとの比較によって検証する必要があります。
